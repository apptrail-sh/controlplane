apptrail:
  metrics-queries:
    enabled: ${METRICS_QUERIES_ENABLED:false}
    sparklines-enabled: ${METRICS_SPARKLINES_ENABLED:false}
    queries:
      - id: error_rate
        name: Error Rate
        description: Percentage of requests resulting in errors
        query: |
          sum(
            rate(tapir_request_total{status="5xx", cluster="{{cluster.name}}", namespace="{{namespace}}"}[5m])
            * on(cluster, namespace, pod) group_left(workload, workload_type)
            namespace_workload_pod:kube_pod_owner:relabel{workload="{{workload.name}}", namespace="{{namespace}}", cluster="{{cluster.name}}"}
          )
          /
          sum(
            rate(tapir_request_total{cluster="{{cluster.name}}", namespace="{{namespace}}"}[5m])
            * on(cluster, namespace, pod) group_left(workload, workload_type)
            namespace_workload_pod:kube_pod_owner:relabel{workload="{{workload.name}}", namespace="{{namespace}}", cluster="{{cluster.name}}"}
          )
        unit: percentage
        category: errors
        sparkline-range: 1h
        sparkline-step: 5m

      - id: request_rate
        name: Request Rate
        description: Total requests per second
        query: |
          sum(
            rate(tapir_request_total{cluster="{{cluster.name}}", namespace="{{namespace}}"}[5m])
            * on(cluster, namespace, pod) group_left(workload, workload_type)
            namespace_workload_pod:kube_pod_owner:relabel{workload="{{workload.name}}", namespace="{{namespace}}", cluster="{{cluster.name}}"}
          )
        unit: requests_per_second
        category: traffic
        sparkline-range: 1h
        sparkline-step: 5m

      - id: latency_p50
        name: p50 Latency
        description: 50th percentile response time
        query: |
          histogram_quantile(0.50,
            sum(
              rate(tapir_request_duration_seconds_bucket{phase="headers", cluster="{{cluster.name}}", namespace="{{namespace}}"}[5m])
              * on(cluster, namespace, pod) group_left(workload, workload_type)
              namespace_workload_pod:kube_pod_owner:relabel{workload="{{workload.name}}", namespace="{{namespace}}", cluster="{{cluster.name}}"}
            ) by (le)
          ) * 1000
        unit: milliseconds
        category: latency
        sparkline-range: 1h
        sparkline-step: 5m

      - id: latency_p95
        name: p95 Latency
        description: 95th percentile response time
        query: |
          histogram_quantile(0.95,
            sum(
              rate(tapir_request_duration_seconds_bucket{phase="headers", cluster="{{cluster.name}}", namespace="{{namespace}}"}[5m])
              * on(cluster, namespace, pod) group_left(workload, workload_type)
              namespace_workload_pod:kube_pod_owner:relabel{workload="{{workload.name}}", namespace="{{namespace}}", cluster="{{cluster.name}}"}
            ) by (le)
          ) * 1000
        unit: milliseconds
        category: latency
        sparkline-range: 1h
        sparkline-step: 5m

      - id: latency_p99
        name: p99 Latency
        description: 99th percentile response time
        query: |
          histogram_quantile(0.99,
            sum(
              rate(tapir_request_duration_seconds_bucket{phase="headers", cluster="{{cluster.name}}", namespace="{{namespace}}"}[5m])
              * on(cluster, namespace, pod) group_left(workload, workload_type)
              namespace_workload_pod:kube_pod_owner:relabel{workload="{{workload.name}}", namespace="{{namespace}}", cluster="{{cluster.name}}"}
            ) by (le)
          ) * 1000
        unit: milliseconds
        category: latency
        sparkline-range: 1h
        sparkline-step: 5m
