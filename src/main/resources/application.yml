spring:
  application:
    name: controlplane
  profiles:
    include:
      - queries
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/apptrail
    username: ${DB_USERNAME:apptrail}
    password: ${DB_PASSWORD:apptrail}
    hikari:
      maximum-pool-size: ${DB_POOL_MAX_SIZE:15}
      connection-timeout: ${DB_POOL_CONNECTION_TIMEOUT:30000}
      idle-timeout: ${DB_POOL_IDLE_TIMEOUT:600000}
      max-lifetime: ${DB_POOL_MAX_LIFETIME:1800000}
  flyway:
    enabled: true
  jpa:
    hibernate:
      ddl-auto: validate
  docker:
    compose:
      lifecycle-management: start-only
      enabled: false

apptrail:
  backfill:
    cell:
      enabled-on-startup: false  # Set to true to run cell backfill on startup
  clusters:
    # Unified cluster definitions
    # Example configuration:
    # definitions:
    #   cluster-staging-gke-usce1:
    #     environment: staging
    #     alias: stg.01
    #     cell:
    #       name: canary
    #       order: 0
    #     namespaces:  # Optional namespace-level shard overrides
    #       special-ns:
    #         cell:
    #           name: shard02
    #           order: 2
    # definitions: {}  # Removed - let profile-specific config provide this
    environments:
      - name: dev
        order: 0
      - name: staging
        order: 1
      - name: production
        order: 2
  ingest:
    http:
      enabled: true
    pubsub:
      enabled: ${PUBSUB_ENABLED:false}
      subscription: ${PUBSUB_SUBSCRIPTION:}
    team-label: team
  gitprovider:
    github:
      enabled: ${GITHUB_APP_ENABLED:false}
      app-id: ${GITHUB_APP_ID:}
      private-key-path: ${GITHUB_APP_PRIVATE_KEY_PATH:}
      private-key-base64: ${GITHUB_APP_PRIVATE_KEY_BASE64:}
      api-base-url: ${GITHUB_API_BASE_URL:https://api.github.com}
      webhook-secret: ${GITHUB_WEBHOOK_SECRET:}
  release-fetch:
    enabled: true
    interval-ms: ${RELEASE_FETCH_INTERVAL_MS:30000}
  cors:
    allowed-origins:
      - "http://localhost:5173"
      - "http://localhost:3000"
    allowed-methods:
      - "GET"
      - "POST"
      - "PUT"
      - "PATCH"
      - "DELETE"
      - "OPTIONS"
    allowed-headers:
      - "*"
    allow-credentials: false
    max-age: 3600
  alerting:
    prometheus:
      enabled: ${PROMETHEUS_ENABLED:false}
      base-url: ${PROMETHEUS_BASE_URL:http://localhost:8481}
      query-path: ${PROMETHEUS_QUERY_PATH:/select/0:0/prometheus/api/v1/query}
      timeout-ms: ${PROMETHEUS_TIMEOUT_MS:5000}
      cache:
        enabled: true
        ttl-seconds: 30
  cleanup:
    cluster-status-check-interval-ms: ${CLEANUP_STATUS_CHECK_INTERVAL_MS:300000}
    cluster-offline-threshold-minutes: ${CLEANUP_OFFLINE_THRESHOLD_MINUTES:15}
    stale-cleanup-cron: ${CLEANUP_STALE_CRON:0 0 4 * * ?}
    stale-cluster-offline-days: ${CLEANUP_STALE_OFFLINE_DAYS:7}
    hard-delete-cron: ${CLEANUP_HARD_DELETE_CRON:0 0 3 * * ?}
    hard-delete-retention-days: ${CLEANUP_HARD_DELETE_RETENTION_DAYS:30}
    heartbeat-retention-days: ${CLEANUP_HEARTBEAT_RETENTION_DAYS:7}

  notifications:
    enabled: ${NOTIFICATIONS_ENABLED:false}
    frontend-base-url: ${FRONTEND_BASE_URL:http://localhost:5173}
    channels:
      - name: "default-slack"
        type: slack
        enabled: true
        notification-types:
          - DEPLOYMENT_STARTED
          - DEPLOYMENT_SUCCEEDED
          - DEPLOYMENT_FAILED
        slack:
          webhook-url: "${SLACK_WEBHOOK_URL:}"
          channel: "#apptrail"
    # Example channel configuration:
    # channels:
    #   - name: "team1-failures"
    #     type: slack
    #     enabled: true
    #     team: "team1"                    # Optional: filter by team (null = all)
    #     environments:                    # Optional: filter by environment (null = all)
    #       - production
    #     notification-types:
    #       - DEPLOYMENT_FAILED
    #     slack:
    #       webhook-url: "${SLACK_WEBHOOK_TEAM1:}"
    #       channel: "#team1-alerts"       # Display reference in messages
    #       mention-on-failure: "@oncall"  # Optional
    #
    #   - name: "all-production-deploys"
    #     type: slack
    #     enabled: true
    #     environments:
    #       - production
    #     notification-types:
    #       - DEPLOYMENT_SUCCEEDED
    #       - DEPLOYMENT_FAILED
    #     slack:
    #       webhook-url: "${SLACK_WEBHOOK_PRODUCTION:}"
    #       channel: "#production-deployments"

  node-metrics:
    enabled: ${NODE_METRICS_ENABLED:true}
    cluster-label: ${NODE_METRICS_CLUSTER_LABEL:cluster}
    node-label: ${NODE_METRICS_NODE_LABEL:node}
    cpu-query: ${NODE_METRICS_CPU_QUERY:100 - (avg(rate(node_cpu_seconds_total{mode="idle", {{nodeLabel}}="{{nodeName}}", {{clusterLabel}}="{{clusterName}}"}[5m])) * 100)}
    memory-query: ${NODE_METRICS_MEMORY_QUERY:(1 - (node_memory_MemAvailable_bytes{{{nodeLabel}}="{{nodeName}}", {{clusterLabel}}="{{clusterName}}"} / node_memory_MemTotal_bytes{{{nodeLabel}}="{{nodeName}}", {{clusterLabel}}="{{clusterName}}"})) * 100}

  pod-metrics:
    enabled: ${POD_METRICS_ENABLED:true}
    cluster-label: ${POD_METRICS_CLUSTER_LABEL:cluster}
    namespace-label: ${POD_METRICS_NAMESPACE_LABEL:namespace}
    pod-label: ${POD_METRICS_POD_LABEL:pod}
    cpu-query: ${POD_METRICS_CPU_QUERY:sum(rate(container_cpu_usage_seconds_total{{{podLabel}}="{{podName}}", {{namespaceLabel}}="{{namespace}}", {{clusterLabel}}="{{clusterName}}", container!=""}[5m]))}
    memory-query: ${POD_METRICS_MEMORY_QUERY:sum(container_memory_working_set_bytes{{{podLabel}}="{{podName}}", {{namespaceLabel}}="{{namespace}}", {{clusterLabel}}="{{clusterName}}", container!=""})}
    cpu-limit-query: ${POD_METRICS_CPU_LIMIT_QUERY:sum(kube_pod_container_resource_limits{resource="cpu", {{podLabel}}="{{podName}}", {{namespaceLabel}}="{{namespace}}", {{clusterLabel}}="{{clusterName}}"})}
    memory-limit-query: ${POD_METRICS_MEMORY_LIMIT_QUERY:sum(kube_pod_container_resource_limits{resource="memory", {{podLabel}}="{{podName}}", {{namespaceLabel}}="{{namespace}}", {{clusterLabel}}="{{clusterName}}"})}

  quick-links:
    links:
      - name: "GCP Logs"
        description: "View logs in Google Cloud Console"
        urlTemplate: "https://console.cloud.google.com/logs/query;query=resource.labels.cluster_name%3D%22{{cluster.name}}%22%0Aresource.labels.namespace_name%3D%22{{instance.namespace}}%22;project={{environment.metadata.gcp-project}}"
        linkType: url
        icon: gcp
      - name: "Grafana Dashboard"
        description: "View metrics in Grafana"
        urlTemplate: "https://grafana.example.com/d/k8s?var-namespace={{instance.namespace}}&var-workload={{workload.name}}"
        linkType: url
        icon: grafana
      - name: "kubectl describe"
        description: "Describe the workload pods"
        urlTemplate: "kubectl --context=$(kubectl config get-contexts -o name | grep -i '{{cluster.name}}' | head -1) -n {{instance.namespace}} describe {{workload.kind | lowercase}}/{{workload.name}}"
        linkType: command
        icon: terminal

server:
  port: 3000
